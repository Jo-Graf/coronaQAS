<!DOCTYPE html>
<html>
   <head>
      {{ graph | safe | json_script:"graph_var" }}

      <title>Covid19: QAS</title>
      <!-- Add Bootstrap and Bootstrap-Vue CSS to the <head> section -->
      <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap/dist/css/bootstrap.min.css"/>
      <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.css"/>
      <style>
          .carousel-control-next,
          .carousel-control-prev {
              filter: invert(100%);
          }
          .topic-tag-group > .row {
              display: block;
              overflow-x: auto;
              white-space: nowrap;
          }
          .topic-tag-group > .row > .mt-1{
              display: inline-block;

          }
          a {
            color: var(--info);
          }
          .custom-checkbox .custom-control-input:checked ~ .custom-control-label::before {
              background-color: var(--info)!important;
              border-color: var(--info)!important;
          }
      </style>
   </head>
   <body>
      <div id="qas-ui">
         <div>
            <b-navbar toggleable="lg" type="dark" variant="info">
               <b-navbar-brand href="#">Covid19 - QAS</b-navbar-brand>
               <b-navbar-toggle target="nav-collapse"></b-navbar-toggle>
               <b-collapse id="nav-collapse" is-nav>
                  <b-navbar-nav>
                     <b-nav-item href="#" active>Search</b-nav-item>
                     <b-nav-item href="#">Bookmarked</b-nav-item>
                      <b-nav-item href="#">History</b-nav-item>
                  </b-navbar-nav>
                  <!-- Right aligned nav items -->
                  <b-navbar-nav class="ml-auto">
                      <b-nav-item-dropdown
                              class="ml-2"
                              right>
                          <template #button-content>
                              <em>[[display_username]]</em>
                          </template>
                          <b-dropdown-item
                                  v-if="logged_in"
                                  v-on:click="logout()">Sign Out</b-dropdown-item>
                          <div class="m-2">
                              <b-form-input
                                      v-if="!logged_in"
                                      v-model="username"
                                      placeholder="Username"
                                      class="mt-2"
                                      :state="username_field_state"
                                      aria-describedby="username-input-live-feedback"
                                      trim></b-form-input>
                              <b-form-invalid-feedback id="username-input-live-feedback">
                                  Enter at least 5 letters
                              </b-form-invalid-feedback>

                              <b-form-input
                                      v-if="!logged_in"
                                      v-model="password"
                                      type="password"
                                      placeholder="Password"
                                      class="mt-2"
                                      :state="password_field_state"
                                      aria-describedby="password-input-live-feedback"
                                      trim ></b-form-input>
                              <b-form-invalid-feedback id="password-input-live-feedback">
                                      Enter at least 8 letters
                              </b-form-invalid-feedback>

                              <b-dropdown-item
                                      v-if="!logged_in"
                                      v-on:click="login()">Sign In</b-dropdown-item>
                          </div>
                      </b-nav-item-dropdown>
                  </b-navbar-nav>
               </b-collapse>
            </b-navbar>
         </div>
         <b-container fluid>

             <b-row align-h="center" class="mt-3">
               <b-col cols="6">
                  <h2>Search</h2>
               </b-col>
            </b-row>

             <b-row align-h="center" class="mt-3">
               <b-col cols="6">
                  <h3>Question</h3>
                  <b-row align-h="center" class="mt-3">
                      <b-col cols="10">
                          <b-form-input placeholder="Enter your COVID-19 related question"
                                        v-model="selected_question"></b-form-input>
                      </b-col>
                      <b-col cols="2">
                          <b-button block
                                    variant="info"
                                    v-on:click="ask_question()">Search</b-button>
                      </b-col>
                  </b-row>
                  <!--b-form-group id="input-group-3" label="" label-for="input-3">
                     <b-form-select id="input-3" v-model="selected_question" v-bind:options="questions"></b-form-select>
                  </--b-form-group-->
                   <h3 class="mt-3">Suggested Questions</h3>
                   <b-form-select v-model="selected_question" :options="questions" :select-size="3"></b-form-select>
               </b-col>
            </b-row>

            <b-row align-h="center" class="mt-3">
               <b-col cols="1" v-for="n in 3">
                   <b-spinner type="grow" label="Spinning" v-show="answer_is_loading"></b-spinner>
               </b-col>
            </b-row>

            <b-row align-h="center" v-show="show_answer_and_results">
               <b-col cols="6" v-if="best_answer != null">
                   <h3>Most likely answer</h3>
                   <b-card>
                       <b-card-text>[[best_answer.answer]]</b-card-text>
                   </b-card>
               </b-col>
            </b-row>

            <b-row align-h="center" class="mt-3" v-show="show_answer_and_results">
               <b-col cols="6">
                   <h3>Results</h3>
                   <div>
                       <b-list-group>
                           <b-list-group-item
                                v-for="(paper, index) in papers"
                                style="border: none;">
                               <b-card v-bind:title="paper.meta.title" v-bind:sub-title="paper.meta.subtitle">
                                   <h5 class="mt-4">Score: [[Math.round(paper.probability*100)]]%</h5>
                                   <h5 class="mt-4">Answer</h5>
                                   <b-card-text class="mt-2">[[paper.answer]]</b-card-text>
                                   <h5 class="mt-4">Context</h5>
                                   <b-card-text class="mt-2">[[paper.context]]</b-card-text>

                                   <a class="card-link"
                                      v-on:click="show_paper_detail([[index]])">
                                       <b :style="'color:' + hex_primary_color">[[more_less_display_title(index)]]</b>
                                   </a>

                                   <b-tabs
                                           v-show="index == selected_paper"
                                           class="mt-4"
                                           variant="info">
                                       <b-tab active
                                              title="Details">
                                           <div v-if="!lda_is_loading">
                                               <h5 class="mt-4">Top [[lda_results.length]] Topics:</h5>
                                               <div class="container topic-tag-group" v-for="(topic, topic_index) in lda_results.topics">
                                                   <div class="mt-3"> Topic [[topic_index]]:</div>
                                                       <b-progress max=100 height="2rem" class="mt-2" variant="info">
                                                           <b-progress-bar :value="lda_results.topic_probabilities[topic_index]*100">
                                                               <span>
                                                                   <strong>[[(lda_results.topic_probabilities[topic_index]*100).toFixed(2)]]%</strong>
                                                               </span>
                                                           </b-progress-bar>
                                                       </b-progress>
                                                   <div class="row text-center">
                                                       <b-form-tag
                                                               v-for="tag in topic.words"
                                                               tagRemoveLabel=" "
                                                               :key="tag"
                                                               :title="tag"
                                                               class="mt-1">
                                                           [[tag]]
                                                       </b-form-tag>
                                                   </div>
                                               </div>
                                               <h5 class="mt-4">Related Papers</h5>
                                               <b-carousel
                                                       id="carousel"
                                                       controls
                                                       indicators
                                                       width="400"
                                                       height="200"
                                                       img-width="400"
                                                       img-height="200">
                                                   <b-carousel-slide
                                                           v-for="(paper, index) in related_papers"
                                                           caption=""
                                                           img-blank
                                                           img-alt="Blank image">
                                                       <b-list-group-item
                                                               style="border: none;">
                                                           <b-card
                                                                   v-bind:title="paper.meta.title"
                                                                   v-bind:sub-title="paper.meta.subtitle"
                                                                   style="color: #000;">
                                                               <b-card-text>[[paper.abstract]]</b-card-text>
                                                           </b-card>
                                                       </b-list-group-item>
                                                   </b-carousel-slide>
                                               </b-carousel>
                                           </div>
                                           <div v-if="lda_is_loading">
                                                   <b-row align-h="center" class="mt-3">
                                                       <b-col cols="1" v-for="n in 3">
                                                           <b-spinner small type="grow" label="Spinning" :style="'color:' + hex_primary_color"></b-spinner>
                                                       </b-col>
                                                   </b-row>
                                               <b-skeleton animation width="85%"
                                                           class="mt-3"></b-skeleton>
                                               <b-skeleton animation width="55%"></b-skeleton>
                                               <b-skeleton animation width="70%"></b-skeleton>
                                           </div>
                                       </b-tab>

                                       <b-tab v-if="(index == selected_paper) && (logged_in)"
                                              title="Remarks">
                                           <h5 class="mt-4">Notes</h5>
                                           <b-form-textarea v-model="selected_user_specific_doc_meta.fields.note"
                                                            placeholder="Enter something..."
                                                            rows="3"
                                                            class="mt-2"
                                           ></b-form-textarea>

                                           <b-form-checkbox v-model="selected_user_specific_doc_meta.fields.bookmarked"

                                                                size="lg"
                                                                class="mt-4">
                                               <h5>Bookmarked</h5>
                                           </b-form-checkbox>

                                           <b-button variant="info"
                                                     class="mt-4"
                                                     v-on:click="update_user_specific_doc_meta()"
                                                     >
                                                   save
                                           </b-button>
                                       </b-tab>

                                   </b-tabs>

                               </b-card>
                           </b-list-group-item>
                       </b-list-group>
                   </div>
               </b-col>
            </b-row>
         </b-container>
      </div>
      <!-- class="demo" Add Vue and BootstrapVue scripts just before the closing </body> tag -->
      <script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.min.js"></script>
      <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
      <script src="https://unpkg.com/vue-chartjs/dist/vue-chartjs.min.js"></script>
      <script src="https://unpkg.com/vue/dist/vue.min.js"></script>
      <script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.js"></script>

      <script>
          Vue.use(BootstrapVue);
          axios.defaults.xsrfCookieName = 'csrftoken'
          axios.defaults.xsrfHeaderName = "X-CSRFTOKEN"

          let graph_var = JSON.parse(document.getElementById('graph_var').textContent);

          let vm = new Vue({
              delimiters: ["[[", "]]"],
              el: "#qas-ui",
              data: {
                  hex_primary_color: "#17a2b8",
                  currentTab: "List",tabs: ["List", "Graph"],
                  selected_paper: null,
                  logged_in: true,
                  username: "",
                  password: "",
                  papers: null,
                  lda_results: [],
                  related_papers: [],
                  user_specific_doc_meta: [],
                  selected_user_specific_doc_meta: null,
                  selected_question: null,
                  best_answer: null,
                  questions: [
                      {
                          value: null,
                          text: 'Please select a question'
                      }
                      ],
                  chartoptions: {
                      responsive: true,
                      maintainAspectRatio: false
                  },
                  search_started: false,
                  answer_is_loading: false,
                  lda_is_loading: false
              },
              computed: {
                  show_answer_and_results: function(){
                      return this.selected_question != null && !this.answer_is_loading && this.search_started;
                  },
                  username_field_state() {
                      return this.username.length > 4 ? true : false
                  },
                  password_field_state() {
                      return this.password.length > 7 ? true : false
                  },
                  display_username() {
                      return (vm.logged_in && vm.username.length > 0)? vm.username : "User"
                  }
              },
              methods: {
                  show_paper_detail: function(index) {

                      if(parseInt(vm.selected_paper,10) === parseInt(index,10)) {
                          vm.selected_paper = null;
                          vm.lda_results = [];
                          vm.related_papers = [];
                      }else{
                          vm.selected_paper = null;
                          vm.lda_results = [];
                          vm.related_papers = [];
                          let paper = vm.papers[index]
                          vm.selected_paper = index;
                          vm.selected_user_specific_doc_meta = user_specific_doc_meta(paper.doc_id);
                          load_lda(paper);
                      }
                  },
                  login: function(){
                      axios.post('http://127.0.0.1:8000/login/',
                          {
                              username: vm.username,
                              password: vm.password
                          }).then((response) => {
                              vm.logged_in = response.data['success'];
                              let variant = vm.logged_in? 'success' : 'danger';
                              this.$bvToast.toast(response.data['message'], {
                                  title: 'Login information',
                                  autoHideDelay: 5000,
                                  appendToast: true,
                                  variant: variant
                              });
                          }
                      );

                  },
                  logout: function(){
                      axios.get('http://127.0.0.1:8000/logout/')
                          .then((response) => {
                              vm.logged_in = !response.data['success'];
                              let variant = !vm.logged_in? 'success' : 'danger';
                              this.$bvToast.toast(response.data['message'], {
                                  title: 'Login information',
                                  autoHideDelay: 5000,
                                  appendToast: true,
                                  variant: variant
                              });
                          }
                      );
                  },
                  update_user_specific_doc_meta: function(){
                      let paper = vm.papers[vm.selected_paper]
                      let doc_id = paper.doc_id;
                      let meta = paper.meta;
                      let bookmarked = vm.selected_user_specific_doc_meta.fields.bookmarked;
                      let note = vm.selected_user_specific_doc_meta.fields.note;

                      update_user_specific_doc_meta(doc_id, note, bookmarked, meta)
                  },
                  more_less_display_title: function(index){
                      return (parseInt(vm.selected_paper,10) === parseInt(index,10)) ? "- less" : "+ more";
                  },
                  ask_question: function(){
                      vm.selected_paper = null;
                      ask_question(vm.selected_question)
                  }
            },
            watch: {
                  selected_question: function (val) {
                      // vm.selected_paper = null;
                      // ask_question(val);
                  },
                  logged_in: function (val) {
                    update_logged_in(val);
                  }
            },
            mounted(){
                  load_question_selection();
                  check_login();
            },
          });

          function update_logged_in(logged_in){
              vm.password = ""
              if(logged_in === true){
                  load_user_specific_doc_meta();
              }else{
                  vm.username = ""
                  vm.user_specific_doc_meta = [];
                  vm.selected_user_specific_doc_meta = null;
              }
          }

          function user_specific_doc_meta(doc_id){
              let empty_doc_meta = {
                  fields: {
                      note: "",
                      bookmarked: false
                  }
              }

              if(!doc_id ||!vm.user_specific_doc_meta||vm.user_specific_doc_meta.length<1){
                  return empty_doc_meta;
              }

              for (let i = 0; i < vm.user_specific_doc_meta.length; i++) {
                  let doc = vm.user_specific_doc_meta[i];

                  if(doc_id.includes(doc.fields.doc_id)){
                      return doc;
                  }
              }

              return empty_doc_meta;
          }

          function update_user_specific_doc_meta(doc_id, note, bookmarked, doc_meta){
              let change_dic = {'doc_id': doc_id};

              if(note != null)
                  change_dic['doc_note'] = note
              if(bookmarked != null)
                  change_dic['doc_bookmarked'] = bookmarked

              axios.post('http://127.0.0.1:8000/update_user_specific_doc_meta/',change_dic).then((response) => {

                  let success = response.data['success'];
                  let message = response.data['message'];
                  let user_specific_doc_meta = response.data['user_specific_doc_meta']

                  if(success){
                      user_specific_doc_meta.fields.meta = doc_meta

                      let removeIndex = vm.user_specific_doc_meta.map(function(item){
                          return item.fields.doc_id;
                      }).indexOf(user_specific_doc_meta.fields.id);

                      if(removeIndex>=0) {
                          vm.user_specific_doc_meta.splice(removeIndex, 1);
                      }

                      vm.user_specific_doc_meta.push(user_specific_doc_meta)
                  }

                  let variant = success? 'success' : 'danger';
                  vm.$bvToast.toast(message, {
                      title: 'Update information',
                      autoHideDelay: 5000,
                      appendToast: true,
                      variant: variant
                  });
              });
          }

          function check_login(){
              axios.get('http://127.0.0.1:8000/login/').then((response) => {
                  vm.logged_in = response.data['logged_in'];
                  vm.username = response.data['username'];
                  update_logged_in(vm.logged_in);
              });
          }

          function load_user_specific_doc_meta(){
              axios.post('http://127.0.0.1:8000/user_specific_doc_meta/',{
              }).then((response) => {
                  vm.user_specific_doc_meta = response.data
              });
          }

          function load_lda(paper, index) {
              vm.lda_is_loading = true;

              let ids = []

              for (let i = 0; i < vm.papers.length; i++) {
                  ids.push(vm.papers[i].doc_id);
              }

              axios.post('http://127.0.0.1:8000/lda/',
                  {
                      doc_id: paper.doc_id,
                      doc_ids: ids
                  }).then((response) => {
                    vm.lda_results = response.data;
                    vm.lda_results = filter_lda_results(vm.lda_results, 3);

                    let nearest_neighbours = response.data["nearest_neighbours"];

                    for (let i = 0; i < vm.papers.length; i++) {
                      let curr_id = vm.papers[i].doc_id;
                      if (new RegExp(nearest_neighbours.join("|")).test(curr_id)){
                          vm.related_papers.push(vm.papers[i]);
                      }
                    }
                    vm.lda_is_loading = false;
                  });
          }

          function load_question_selection() {
              axios.get('http://127.0.0.1:8000/question_selection/')
                  .then(response => (
                      vm.questions = response.data
                      )
                  );
          }

          function ask_question(question){

              vm.answer_is_loading = true;
              vm.search_started = true;

              axios.post('http://127.0.0.1:8000/qas/',
                  {
                      question: question
                  }).then((response) => {
                  vm.answer_is_loading = false;
                  // vm.papers = response.data['answers']
                  // vm.best_answer = response.data['answers'][0]
                  vm.papers = response.data
                  vm.best_answer = response.data[0]

                  },(error) => {
                      vm.answer_is_loading = false;
                      console.log(error);
                  });
          }
          function un_decorate_sort(arr1, arr2){
              return arr1
                  .map((item, index) => [arr2[index], item])
                  .sort(([arg1], [arg2]) => arg2 - arg1)
                  .map(([, item]) => item)
          }

          function filter_lda_results(results, top_k){
              let n_topics = Math.min(top_k, results.topics.length);
              let topics = results.topics;
              let probabilities = results.topic_probabilities;

              let sorted_topics = un_decorate_sort(topics, probabilities).slice(0, n_topics);
              let sorted_probabilities = un_decorate_sort(probabilities, probabilities).slice(0, n_topics);

              results.topics = sorted_topics;
              results.topic_probabilities = sorted_probabilities;

              return results;
          }
      </script>
   </body>
</html>

